schedy_heating:  # This is our app instance name.
  module: hass_apps_loader
  class: SchedyApp

  debug: false

  reset_at_startup: false

  actor_type: thermostat

  expression_environment: |
    def home_tomorrow():
        return state("input_boolean.home_tomorrow")

    def house_mode():
        return state("input_select.house_mode")

  schedule_snippets:

  watched_entities:
    - input_boolean.home_tomorrow
    - input_boolean.house_vacant
    - input_select.house_mode
    - device_tracker.life360_gareth
    - device_tracker.life360_varina

  schedule_prepend:
    - x: "10 if house_mode() == 'Away' else Next()"

  # default rule to apply if no other matches
  schedule_append:
    - v: 17

  rooms:
    bedroom_1:
      rescheduling_delay: 60
      actors:
        climate.bedroom_1_radiator_thermostat:
      schedule:
        - v: 19
          rules:
            - x: "17 if is_on('input_boolean.house_vacant') else Next()"
            - { start: "07:00", end: "09:00" }
            - { start: "19:00", end: "22:00" }

    bedroom_2:
      allow_manual_changes: true
      actors:
        climate.bedroom_2_radiator_thermostat:
      schedule:
        - v: 21
          rules:
            - weekdays: 1-5
              rules:
              - rules:
                - x: "17 if state('device_tracker.life360_varina') == 'not_home' else Next()"
                - x: "Next() if house_mode() == 'Home - Normal Day' else Break()"
                - { start: "07:00", end: "09:00" }
                - { start: "17:00", end: "22:00" }
              - rules:
                - x: "17 if state('device_tracker.life360_varina') == 'not_home' else Next()"
                - x: "Next() if house_mode() == 'Home - Home Day' else Break()"
                - { start: "07:00", end: "22:00" }
            - weekdays: 6-7
              rules:
                - x: "17 if state('device_tracker.life360_varina') == 'not_home' else Next()"
                - { start: "07:00", end: "22:00" }

    landing:
      actors:
        climate.landing_radiator_thermostat:
      schedule:
        - x: "17 if is_on('input_boolean.house_vacant') else Next()"
        - v: 19

    livingroom:
      rescheduling_delay: 120
      replicate_changes: true
      actors:
        climate.livingroom_radiator_thermostat:
        climate.diningroom_radiator_thermostat:
      schedule:
        - v: 21
          rules:
            - weekdays: 1-5
              rules:
              - rules:
                - x: "17 if is_on('input_boolean.house_vacant') else Next()"
                - x: "Next() if house_mode() == 'Home - Normal Day' else Break()"
                - { start: "07:00", end: "09:00" }
                - { start: "17:00", end: "22:00" }
              - rules:
                - x: "17 if is_on('input_boolean.house_vacant') else Next()"
                - x: "Next() if house_mode() == 'Home - Home Day' else Break()"
                - { start: "07:00", end: "22:00" }
            - weekdays: 6-7
              rules:
                - x: "17 if is_on('input_boolean.house_vacant') else Next()"
                - { start: "07:00", end: "22:00" }

    shack:
      allow_manual_changes: true
      actors:
        climate.shack_thermostat:
      schedule:
        - v: 19
          rules:
            - x: "17 if state('device_tracker.life360_gareth') == 'not_home' or is_on('input_boolean.house_vacant') else Next()"
            - { start: "08:30", end: "22:00" }

  statistics:
    shack_temp_delta:
      type: temp_delta
      rooms:
        shack:
